<?xml version="1.0" encoding="UTF-8"?>
<config>
  <!--
    output formatting
  -->
  <output_align>1</output_align>
  <output_encoding>ascii</output_encoding>
  <output_fieldcase>lower</output_fieldcase>
  <output_format>bibtex</output_format>
  <output_indent>2</output_indent>

  <!--
    sort by title
  -->
  <sortingtemplate name="tool">
    <sort order="1">
      <sortitem order="1">citeorder</sortitem>
      <!-- <sortitem order="1">title</sortitem> -->
    </sort>
  </sortingtemplate>

  <!--
    use legacy bibtex format
  -->
  <!-- Kind of inspiration, but only incomplete sourcemap: https://gist.github.com/mkouhia/f00fea7fc8d4effd9dfd -->
  <!-- First, specify that we do not want to use the date format -->
  <output_legacy_dates>1</output_legacy_dates>
  <!--
  Since we keep the legacy bibtex format, we need to overwrite the previous sourcemap to map to the modern biblatex field, and then we need to map them back in output_field_replace.
  The magic key is 'map_overwrite' as it entirely overwrite.
  -->
  <sourcemap>
    <maps datatype="bibtex" map_overwrite="1">
      <map>
        <map_step map_field_source="address" map_field_target="location"/>
        <map_step map_field_source="archiveprefix" map_field_target="eprinttype"/>
        <map_step map_field_source="journal" map_field_target="journaltitle"/>
      </map>
    </maps>
  </sourcemap>
  <output_field_replace>location:address,eprinttype:archiveprefix,journaltitle:journal</output_field_replace>
  <!-- We need to teach biber about some more legacy fields: phdthesis, mastersthesis, techreport
       And also some legacy fields: school, publisher, copyright -->
  <datamodel>
    <fields>
      <field fieldtype="field" datatype="literal">copyright</field>
      <field fieldtype="field" datatype="literal">publisher</field>
      <field fieldtype="field" datatype="literal">school</field>
    </fields>
    <entrytypes>
      <entrytype>mastersthesis</entrytype>
      <entrytype>phdthesis</entrytype>
      <entrytype>techreport</entrytype>
    </entrytypes>
    <entryfields>
      <field>copyright</field>
      <field>publisher</field>
    </entryfields>
    <entryfields>
      <entrytype>mastersthesis</entrytype>
      <entrytype>phdthesis</entrytype>
      <field>addendum</field>
      <field>author</field>
      <field>chapter</field>
      <field>eid</field>
      <field>issn</field>
      <field>language</field>
      <field>note</field>
      <field>number</field>
      <field>pages</field>
      <field>pagetotal</field>
      <field>pubstate</field>
      <field>school</field>
      <field>series</field>
      <field>subtitle</field>
      <field>title</field>
      <field>titleaddon</field>
      <field>type</field>
    </entryfields>
    <entryfields>
      <entrytype>techreport</entrytype>
      <field>addendum</field>
      <field>author</field>
      <field>chapter</field>
      <field>eid</field>
      <field>institution</field>
      <field>isrn</field>
      <field>language</field>
      <field>location</field>
      <field>note</field>
      <field>number</field>
      <field>pages</field>
      <field>pagetotal</field>
      <field>pubstate</field>
      <field>subtitle</field>
      <field>title</field>
      <field>titleaddon</field>
      <field>type</field>
      <field>version</field>
    </entryfields>
    <multiscriptfields>
      <field>copyright</field>
      <field>publisher</field>
      <field>school</field>
    </multiscriptfields>
    <constraints>
      <entrytype>mastersthesis</entrytype>
      <entrytype>phdthesis</entrytype>
      <entrytype>techreport</entrytype>
      <constraint type="mandatory">
        <fieldxor>
          <field>date</field>
          <field>year</field>
        </fieldxor>
      </constraint>
    </constraints>
    <constraints>
      <entrytype>mastersthesis</entrytype>
      <entrytype>phdthesis</entrytype>
      <constraint type="mandatory">
        <field>author</field>
        <field>school</field>
        <field>title</field>
      </constraint>
    </constraints>
    <constraints>
      <entrytype>techreport</entrytype>
      <constraint type="mandatory">
        <field>author</field>
        <field>institution</field>
        <field>title</field>
      </constraint>
    </constraints>
  </datamodel>
</config>
